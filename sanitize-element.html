<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="sanitize-import.html">

<!--
Element wrapper for the [Sanitize.js](https://github.com/gbirke/Sanitize.js) library (a whitelist-based HTML sanitizer),
to use [`<marked-element>`](https://github.com/polymerelements/marked-element).
-->
<dom-module id="sanitize-element">
  <script>
    class SanitizeElement extends Polymer.Element {
      static get is() {
        return 'sanitize-element'
      }
      static get properties() {
        return {
          /**
           * Custom configuration object. ([parameters](https://github.com/gbirke/Sanitize.js#configuration-object-parameters))
           */
          config: {
            type: Object,
            value: null
          },
          /**
           * Function used for `<marked-element>`
           *
           * without `config`, sanitize all elements and attributes.
           */
          sanitizer: {
            type: Function,
            readOnly: true,
            notify: true,
            computed: "_sanitizer(config)"
          }
        }
      }
      /**
       * Return function of sanitizer for marked-element.
       */
      _sanitizer(config) {
        let sa = new Sanitize(config),
            xs = new XMLSerializer()
        return i=>{
          let isEnd = i.match(/^<\//),
              start = isEnd ? i.replace(/^<\//,'<') : i,
              tmp = document.createElement('div'),
              sani = ''
          tmp.innerHTML = start
          sani = xs.serializeToString(sa.clean_node(tmp))
                   .replace(/ xmlns="[^"]+"/,'')
                   .replace(/<\/[^>]+>$/,'')
          return sani === '' ? '' : isEnd ? i : sani
        }
      }
    }
    customElements.define(SanitizeElement.is, SanitizeElement)
  </script>
</dom-module>
